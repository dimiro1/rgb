<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>RGB - Game Boy Emulator</title>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            body {
                font-family: 'Press Start 2P', cursive;
                background: #2c3e50;
                background-image:
                    radial-gradient(circle at 20% 50%, rgba(52, 73, 94, 0.2) 0%, transparent 50%),
                    radial-gradient(circle at 80% 80%, rgba(52, 73, 94, 0.2) 0%, transparent 50%);
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            }

            .gameboy {
                width: 600px;
                background: linear-gradient(145deg, #c4c4b8 0%, #b0b0a0 100%);
                border-radius: 15px 15px 40px 15px;
                padding: 30px;
                box-shadow:
                    0 20px 60px rgba(0, 0, 0, 0.4),
                    inset 0 2px 5px rgba(255, 255, 255, 0.3),
                    inset 0 -3px 8px rgba(0, 0, 0, 0.15);
                border: 3px solid #9c9c8c;
                position: relative;
            }

            /* Header */
            .header {
                text-align: center;
                margin-bottom: 15px;
            }

            .nintendo-logo {
                font-size: 0.7em;
                color: #5c5c50;
                letter-spacing: 4px;
                margin-bottom: 5px;
                text-shadow: 1px 1px 0 rgba(255, 255, 255, 0.3);
            }

            .gameboy-text {
                font-size: 0.6em;
                color: #3c3c34;
                letter-spacing: 6px;
                font-style: italic;
                margin-bottom: 3px;
            }

            .power-led {
                width: 8px;
                height: 8px;
                background: #ff4444;
                border-radius: 50%;
                margin: 8px auto;
                box-shadow:
                    inset 0 1px 2px rgba(0, 0, 0, 0.5),
                    0 0 5px rgba(255, 68, 68, 0.5);
                position: relative;
            }

            .power-led.on {
                background: #44ff44;
                box-shadow:
                    inset 0 1px 2px rgba(0, 0, 0, 0.5),
                    0 0 10px rgba(68, 255, 68, 0.8);
            }

            /* Screen */
            .screen-container {
                background: #0f380f;
                border-radius: 8px;
                padding: 20px;
                margin-bottom: 20px;
                box-shadow:
                    inset 0 4px 12px rgba(0, 0, 0, 0.8),
                    inset 0 -2px 6px rgba(255, 255, 255, 0.05);
                position: relative;
            }

            .screen-label {
                position: absolute;
                top: 5px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 0.45em;
                color: #0f380f;
                opacity: 0.3;
                letter-spacing: 2px;
            }

            #gameboy-screen {
                display: block;
                margin: 0 auto;
                border: 3px solid #0f380f;
                border-radius: 3px;
                image-rendering: pixelated;
                image-rendering: -webkit-optimize-contrast;
                image-rendering: crisp-edges;
                -ms-interpolation-mode: nearest-neighbor;
                box-shadow: 0 0 20px rgba(139, 172, 15, 0.2);
            }

            /* Nintendo Branding */
            .branding {
                text-align: center;
                margin-bottom: 20px;
                font-size: 0.5em;
                color: #4c4c44;
                letter-spacing: 3px;
            }

            /* Controls */
            .controls {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 15px;
                align-items: center;
                margin-bottom: 20px;
            }

            /* D-Pad */
            .dpad {
                position: relative;
                width: 100px;
                height: 100px;
                justify-self: center;
            }

            .dpad-btn {
                position: absolute;
                background: #3c3c34;
                width: 32px;
                height: 32px;
                cursor: pointer;
                box-shadow:
                    0 3px 0 #1c1c18,
                    inset 0 1px 0 rgba(255, 255, 255, 0.1);
                transition: all 0.1s;
            }

            .dpad-btn.disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .dpad-btn:active,
            .dpad-btn.pressed {
                transform: translateY(2px);
                box-shadow:
                    0 1px 0 #1c1c18,
                    inset 0 1px 0 rgba(255, 255, 255, 0.1);
            }

            .dpad-up {
                top: 0;
                left: 34px;
                border-radius: 3px 3px 0 0;
            }
            .dpad-down {
                bottom: 0;
                left: 34px;
                border-radius: 0 0 3px 3px;
            }
            .dpad-left {
                left: 0;
                top: 34px;
                border-radius: 3px 0 0 3px;
            }
            .dpad-right {
                right: 0;
                top: 34px;
                border-radius: 0 3px 3px 0;
            }
            .dpad-center {
                top: 34px;
                left: 34px;
                background: #2c2c24;
            }

            /* Start/Select */
            .middle-buttons {
                display: flex;
                flex-direction: column;
                gap: 15px;
                align-items: center;
            }

            .start-select {
                display: flex;
                gap: 10px;
            }

            .small-btn {
                background: #5c5c50;
                border: none;
                padding: 8px 18px;
                border-radius: 15px;
                font-size: 0.4em;
                font-family: 'Press Start 2P', cursive;
                color: white;
                cursor: pointer;
                box-shadow:
                    0 3px 0 #2c2c24,
                    inset 0 1px 0 rgba(255, 255, 255, 0.2);
                transition: all 0.1s;
                text-shadow: 0 1px 1px rgba(0, 0, 0, 0.5);
            }

            .small-btn:active,
            .small-btn.pressed {
                transform: translateY(2px);
                box-shadow:
                    0 1px 0 #2c2c24,
                    inset 0 1px 0 rgba(255, 255, 255, 0.2);
            }

            .small-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            /* A/B Buttons */
            .ab-buttons {
                position: relative;
                width: 115px;
                height: 90px;
                justify-self: center;
            }

            .action-btn {
                position: absolute;
                width: 50px;
                height: 50px;
                border: none;
                border-radius: 50%;
                font-size: 0.65em;
                font-family: 'Press Start 2P', cursive;
                cursor: pointer;
                box-shadow:
                    0 4px 0 #892c1d,
                    inset 0 1px 0 rgba(255, 255, 255, 0.3);
                transition: all 0.1s;
                background: linear-gradient(145deg, #d94c3d 0%, #c93c2d 100%);
                color: white;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            }

            .action-btn:active,
            .action-btn.pressed {
                transform: translateY(3px);
                box-shadow:
                    0 1px 0 #892c1d,
                    inset 0 1px 0 rgba(255, 255, 255, 0.3);
            }

            .btn-a {
                right: 0;
                top: 20px;
            }

            .btn-b {
                left: 0;
                top: 0;
            }

            /* Speaker */
            .speaker {
                display: grid;
                grid-template-columns: repeat(6, 1fr);
                gap: 4px;
                margin-bottom: 15px;
                padding: 10px;
            }

            .speaker-hole {
                width: 100%;
                height: 3px;
                background: #7c7c70;
                border-radius: 2px;
                box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.3);
            }

            /* File Input */
            .file-input-container {
                position: relative;
                overflow: hidden;
            }

            .file-input-container input[type="file"] {
                position: absolute;
                left: -9999px;
            }

            .file-input-label {
                background: linear-gradient(180deg, #7c7c6c 0%, #5c5c50 100%);
                color: white;
                padding: 12px 20px;
                border-radius: 25px;
                font-size: 0.35em;
                font-family: 'Press Start 2P', cursive;
                cursor: pointer;
                display: block;
                text-align: center;
                transition: all 0.1s;
                letter-spacing: 1px;
                box-shadow:
                    0 4px 0 #3c3c30,
                    inset 0 1px 0 rgba(255, 255, 255, 0.2);
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            }

            .file-input-label:hover {
                background: linear-gradient(180deg, #8c8c7c 0%, #6c6c60 100%);
            }

            .file-input-label:active {
                transform: translateY(3px);
                box-shadow:
                    0 1px 0 #3c3c30,
                    inset 0 1px 0 rgba(255, 255, 255, 0.2);
            }

            /* Controls Info */
            .controls-info {
                margin-top: 20px;
                padding: 15px;
                background: rgba(60, 60, 52, 0.1);
                border-radius: 8px;
            }

            .info-title {
                text-align: center;
                font-size: 0.4em;
                color: #4c4c44;
                letter-spacing: 3px;
                margin-bottom: 10px;
            }

            .info-grid {
                display: flex;
                flex-direction: column;
                gap: 5px;
                margin-bottom: 10px;
            }

            .info-item {
                display: flex;
                justify-content: space-between;
                font-size: 0.3em;
                color: #5c5c50;
                padding: 5px 10px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 3px;
            }

            .info-item span:first-child {
                font-weight: bold;
            }

            #customize-keys {
                width: 100%;
                margin-top: 5px;
            }

            /* Bottom branding */
            .footer {
                text-align: center;
                margin-top: 15px;
                font-size: 0.25em;
                color: #6c6c60;
                letter-spacing: 2px;
            }

            @media (max-width: 700px) {
                .gameboy {
                    width: 100%;
                    max-width: 600px;
                }
            }
        </style>
    </head>
    <body>
        <div class="gameboy">
            <!-- Header -->
            <div class="header">
                <div class="nintendo-logo">NINTENDO</div>
                <div class="gameboy-text">GAME BOY™</div>
                <div class="power-led" id="power-led"></div>
            </div>

            <!-- Screen -->
            <div class="screen-container">
                <div class="screen-label">DOT MATRIX WITH STEREO SOUND</div>
                <canvas id="gameboy-screen"></canvas>
            </div>

            <!-- Nintendo Branding -->
            <div class="branding">Nintendo GAME BOY</div>

            <!-- Controls -->
            <div class="controls">
                <!-- D-Pad -->
                <div class="dpad">
                    <div class="dpad-btn dpad-up disabled" id="btn-up"></div>
                    <div class="dpad-btn dpad-down disabled" id="btn-down"></div>
                    <div class="dpad-btn dpad-left disabled" id="btn-left"></div>
                    <div class="dpad-btn dpad-right disabled" id="btn-right"></div>
                    <div class="dpad-btn dpad-center"></div>
                </div>

                <!-- Start/Select -->
                <div class="middle-buttons">
                    <div class="start-select">
                        <button class="small-btn" id="btn-select" disabled>SELECT</button>
                        <button class="small-btn" id="btn-start" disabled>START</button>
                    </div>
                    <button class="small-btn" id="reset-btn" disabled>RESET</button>
                </div>

                <!-- A/B Buttons -->
                <div class="ab-buttons">
                    <button class="action-btn btn-b" id="btn-b" disabled>B</button>
                    <button class="action-btn btn-a" id="btn-a" disabled>A</button>
                </div>
            </div>

            <!-- Speaker -->
            <div class="speaker">
                <div class="speaker-hole"></div>
                <div class="speaker-hole"></div>
                <div class="speaker-hole"></div>
                <div class="speaker-hole"></div>
                <div class="speaker-hole"></div>
                <div class="speaker-hole"></div>
            </div>

            <!-- Load ROM -->
            <div class="file-input-container">
                <input type="file" id="rom-input" accept=".gb,.gbc" />
                <label for="rom-input" class="file-input-label">
                    LOAD CARTRIDGE
                </label>
            </div>

            <!-- Controls Info -->
            <div class="controls-info">
                <div class="info-title">CONTROLS</div>
                <div class="info-grid">
                    <div class="info-item">
                        <span>ARROWS</span>
                        <span>D-PAD</span>
                    </div>
                    <div class="info-item">
                        <span id="key-a">X</span>
                        <span>A</span>
                    </div>
                    <div class="info-item">
                        <span id="key-b">Z</span>
                        <span>B</span>
                    </div>
                    <div class="info-item">
                        <span id="key-select">BACKSPACE</span>
                        <span>SELECT</span>
                    </div>
                    <div class="info-item">
                        <span id="key-start">ENTER</span>
                        <span>START</span>
                    </div>
                </div>
                <button class="small-btn" id="customize-keys">CUSTOMIZE</button>
            </div>

            <!-- Footer -->
            <div class="footer">© 1989 NINTENDO</div>
        </div>

        <script type="module">
            import init, { Emulator } from "./pkg/rgb_wasm.js";

            let emulator = null;
            let animationId = null;

            // DOM elements
            const romInput = document.getElementById("rom-input");
            const startBtn = document.getElementById("btn-start");
            const resetBtn = document.getElementById("reset-btn");
            const powerLed = document.getElementById("power-led");

            // Game buttons
            const btnUp = document.getElementById("btn-up");
            const btnDown = document.getElementById("btn-down");
            const btnLeft = document.getElementById("btn-left");
            const btnRight = document.getElementById("btn-right");
            const btnA = document.getElementById("btn-a");
            const btnB = document.getElementById("btn-b");
            const btnSelect = document.getElementById("btn-select");
            const btnStart = document.getElementById("btn-start");

            // Initialize WASM
            async function initEmulator() {
                try {
                    await init();
                    emulator = new Emulator("gameboy-screen", 3);
                    console.log("Emulator initialized");
                } catch (err) {
                    console.error("Failed to initialize:", err);
                }
            }

            // Load ROM
            romInput.addEventListener("change", async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const romData = new Uint8Array(arrayBuffer);

                    emulator.load_rom(romData);
                    startBtn.disabled = false;
                    resetBtn.disabled = false;
                    btnSelect.disabled = false;
                    btnA.disabled = false;
                    btnB.disabled = false;
                    btnUp.classList.remove("disabled");
                    btnDown.classList.remove("disabled");
                    btnLeft.classList.remove("disabled");
                    btnRight.classList.remove("disabled");

                    console.log("ROM loaded:", file.name);
                } catch (err) {
                    console.error("Failed to load ROM:", err);
                }
            });

            // Start
            startBtn.addEventListener("click", () => {
                if (emulator && !emulator.is_running()) {
                    emulator.start();
                    powerLed.classList.add("on");
                    startEmulationLoop();
                }
            });

            // Reset
            resetBtn.addEventListener("click", () => {
                if (emulator) {
                    emulator.stop();
                    powerLed.classList.remove("on");
                    if (animationId) {
                        cancelAnimationFrame(animationId);
                        animationId = null;
                    }
                    // Reload ROM
                    const file = romInput.files[0];
                    if (file) {
                        file.arrayBuffer().then(buffer => {
                            emulator.load_rom(new Uint8Array(buffer));
                        });
                    }
                }
            });

            // Emulation loop
            function startEmulationLoop() {
                function loop() {
                    if (!emulator || !emulator.is_running()) {
                        return;
                    }

                    try {
                        emulator.step_frame();
                        emulator.render();
                        animationId = requestAnimationFrame(loop);
                    } catch (err) {
                        console.error("Emulation error:", err);
                        emulator.stop();
                        powerLed.classList.remove("on");
                    }
                }
                loop();
            }

            // Default key mappings (can be customized)
            const keyMap = {
                'ArrowRight': 0,  // Right
                'ArrowLeft': 1,   // Left
                'ArrowUp': 2,     // Up
                'ArrowDown': 3,   // Down
                'KeyX': 4,        // A
                'KeyZ': 5,        // B
                'Backspace': 6,   // Select
                'Enter': 7        // Start
            };

            // Track pressed keys to avoid repeats
            const pressedKeys = new Set();

            // Key customization state
            const customizeBtn = document.getElementById("customize-keys");
            let isCustomizing = false;
            let customizingButton = null;

            customizeBtn.addEventListener("click", () => {
                if (!isCustomizing) {
                    isCustomizing = true;
                    customizeBtn.textContent = "Press key for A...";
                    customizingButton = 'a';
                }
            });

            // Unified keyboard handler
            window.addEventListener("keydown", (e) => {
                if (isCustomizing) {
                    e.preventDefault();

                    const oldKey = Object.keys(keyMap).find(key => keyMap[key] === getButtonId(customizingButton));
                    if (oldKey) delete keyMap[oldKey];

                    keyMap[e.code] = getButtonId(customizingButton);
                    updateKeyDisplay(customizingButton, formatKeyName(e.code));

                    const nextButton = getNextButton(customizingButton);
                    if (nextButton) {
                        customizingButton = nextButton;
                        customizeBtn.textContent = `Press key for ${nextButton.toUpperCase()}...`;
                    } else {
                        isCustomizing = false;
                        customizingButton = null;
                        customizeBtn.textContent = "CUSTOMIZE";
                    }
                    return;
                }

                const buttonId = keyMap[e.code];
                if (buttonId !== undefined && emulator && !pressedKeys.has(e.code)) {
                    e.preventDefault();
                    pressedKeys.add(e.code);
                    emulator.key_down(buttonId);
                }
            });

            window.addEventListener("keyup", (e) => {
                const buttonId = keyMap[e.code];
                if (buttonId !== undefined && emulator) {
                    e.preventDefault();
                    pressedKeys.delete(e.code);
                    emulator.key_up(buttonId);
                }
            });

            function getButtonId(name) {
                const map = { 'a': 4, 'b': 5, 'select': 6, 'start': 7 };
                return map[name];
            }

            function getNextButton(current) {
                const order = ['a', 'b', 'select', 'start'];
                const index = order.indexOf(current);
                return index >= 0 && index < order.length - 1 ? order[index + 1] : null;
            }

            function updateKeyDisplay(button, keyName) {
                const element = document.getElementById(`key-${button}`);
                if (element) element.textContent = keyName;
            }

            function formatKeyName(code) {
                if (code.startsWith('Key')) return code.replace('Key', '');
                if (code.startsWith('Digit')) return code.replace('Digit', '');
                if (code.startsWith('Arrow')) return code.replace('Arrow', '').toUpperCase();
                if (code === 'Space') return 'SPACE';
                if (code === 'Backspace') return 'BACKSPACE';
                if (code === 'Enter') return 'ENTER';
                return code;
            }

            // Button handlers helper
            function setupButton(element, buttonId) {
                if (!element) return;

                const isDisabled = () => element.disabled || element.classList.contains("disabled");

                const handlePress = (e) => {
                    e.preventDefault();
                    if (emulator && !isCustomizing && !isDisabled()) {
                        element.classList.add("pressed");
                        emulator.key_down(buttonId);
                    }
                };

                const handleRelease = (e) => {
                    e.preventDefault();
                    element.classList.remove("pressed");
                    if (emulator && !isCustomizing && !isDisabled()) {
                        emulator.key_up(buttonId);
                    }
                };

                element.addEventListener("mousedown", handlePress);
                element.addEventListener("mouseup", handleRelease);
                element.addEventListener("mouseleave", handleRelease);
                element.addEventListener("touchstart", handlePress);
                element.addEventListener("touchend", handleRelease);
                element.addEventListener("touchcancel", handleRelease);
            }

            // Setup all game buttons
            setupButton(btnRight, 0);  // Right
            setupButton(btnLeft, 1);   // Left
            setupButton(btnUp, 2);     // Up
            setupButton(btnDown, 3);   // Down
            setupButton(btnA, 4);      // A
            setupButton(btnB, 5);      // B
            setupButton(btnSelect, 6); // Select
            setupButton(btnStart, 7);  // Start

            // Initialize on load
            window.addEventListener("load", initEmulator);
        </script>
    </body>
</html>
